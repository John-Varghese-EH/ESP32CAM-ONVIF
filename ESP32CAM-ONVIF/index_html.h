#pragma once

// ESP32-CAM ONVIF Web Interface - Auto-generated
// Built: 2026-01-21 15:51:07 | Size: 64,464 bytes
// Edit files in ESP32CAM-ONVIF/data/ then run: python utils/build_web.py

const char index_html[] PROGMEM = R"rawliteral(<!DOCTYPE html><html lang="en"><head><meta charset="UTF-8"><title>ESP32-CAM ONVIF</title><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="theme-color" content="#000000"><link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"><link rel="icon" href="data:,"><script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script><script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script><style>:root{--bg-color:#050510;--glass-bg:rgba(255,255,255,0.05);--glass-border:rgba(255,255,255,0.1);--glass-blur:20px;--primary:#6366f1;--primary-glow:rgba(99,102,241,0.6);--accent:#d946ef;--accent-glow:rgba(217,70,239,0.5);--text-main:#f8fafc;--text-muted:#94a3b8;--success:#10b981;--danger:#ef4444;--radius:16px}*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}body{font-family:'Inter',sans-serif;background:var(--bg-color);background-image:radial-gradient(circle at 10% 20%,rgba(99,102,241,0.25),transparent 40%),radial-gradient(circle at 90% 80%,rgba(217,70,239,0.35),transparent 40%),radial-gradient(circle at 50% 50%,rgba(139,92,246,0.1),transparent 60%);color:var(--text-main);margin:0;min-height:100vh;display:flex;flex-direction:column;overflow-x:hidden}.glass-panel{background:var(--glass-bg);backdrop-filter:blur(var(--glass-blur));-webkit-backdrop-filter:blur(var(--glass-blur));border:1px solid var(--glass-border);border-radius:var(--radius)}header{position:sticky;top:0;z-index:100;padding:1rem 1.5rem;display:flex;justify-content:space-between;align-items:center;background:rgba(5,5,16,0.8);backdrop-filter:blur(12px);border-bottom:1px solid var(--glass-border)}.brand{font-size:1.25rem;font-weight:700;background:linear-gradient(135deg,#fff 0%,#94a3b8 100%);-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:flex;align-items:center;gap:8px}.status-pill{font-size:0.75rem;padding:4px 12px;border-radius:99px;background:rgba(16,185,129,0.1);color:var(--success);border:1px solid rgba(16,185,129,0.2);font-weight:600;display:flex;align-items:center;gap:6px}.status-pill.offline{background:rgba(239,68,68,0.1);color:var(--danger);border-color:rgba(239,68,68,0.2)}.dot{width:6px;height:6px;border-radius:50%;background:currentColor}.pulse{animation:pulse 2s infinite}@keyframes pulse{0%{opacity:1}50%{opacity:0.5}100%{opacity:1}}main{flex:1;width:100%;max-width:1200px;margin:0 auto;padding:1.5rem}.tabs{display:flex;gap:8px;margin-bottom:1.5rem;overflow-x:auto;padding-bottom:4px;scrollbar-width:none}.tabs::-webkit-scrollbar{display:none}.tab-btn{background:transparent;border:none;color:var(--text-muted);padding:8px 16px;border-radius:12px;font-weight:500;cursor:pointer;transition:all 0.2s;white-space:nowrap}.tab-btn.active{background:rgba(255,255,255,0.1);color:#fff;box-shadow:0 4px 12px rgba(0,0,0,0.1)}.video-container{position:relative;background:#000;border-radius:var(--radius);overflow:hidden;aspect-ratio:16/9;box-shadow:0 20px 40px -10px rgba(0,0,0,0.5);border:1px solid var(--glass-border);margin-bottom:2rem}.video-feed{width:100%;height:100%;object-fit:contain;display:block}.video-controls{position:absolute;bottom:0;left:0;right:0;padding:1rem;background:linear-gradient(to top,rgba(0,0,0,0.9),transparent);display:flex;justify-content:center;gap:1rem;opacity:0;transition:opacity 0.3s ease}.video-container:hover .video-controls{opacity:1}@media(max-width:768px){.video-controls{opacity:1 !important;padding:0.8rem}}.video-container.fullscreen{position:fixed;top:0;left:0;width:100vw;height:100vh;z-index:1000;border-radius:0;margin:0}.btn{background:var(--glass-bg);border:1px solid var(--glass-border);color:var(--text-main);padding:10px 18px;border-radius:10px;font-weight:500;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px;font-family:inherit}.btn:hover{background:rgba(255,255,255,0.1);transform:translateY(-1px)}.btn:active{transform:translateY(0)}.btn-primary{background:var(--primary);border-color:transparent;box-shadow:0 0 20px -5px var(--primary-glow)}.btn-primary:hover{background:#4f46e5;box-shadow:0 0 25px -5px var(--primary-glow)}.btn-icon{padding:8px;border-radius:50%;width:40px;height:40px}.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:1.5rem}.card{padding:1.5rem;display:flex;flex-direction:column;gap:1rem}.card h3{margin:0;font-size:1.1rem;font-weight:600;color:#fff;display:flex;align-items:center;gap:8px}.kv-group{display:flex;justify-content:space-between;align-items:center;padding:4px 0;border-bottom:1px solid rgba(255,255,255,0.05)}.kv-group:last-child{border:none}.label{color:var(--text-muted);font-size:0.9rem}.value{font-weight:500;font-family:monospace}.input-group{margin-bottom:0.5rem}.input-label{display:block;color:var(--text-muted);margin-bottom:6px;font-size:0.85rem}.form-control{width:100%;background:rgba(0,0,0,0.3);border:1px solid var(--glass-border);color:#fff;padding:10px;border-radius:8px;font-family:inherit}.form-control:focus{outline:none;border-color:var(--primary)}input[type=range]{width:100%;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;-webkit-appearance:none}input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:16px;height:16px;border-radius:50%;background:var(--primary);cursor:pointer;box-shadow:0 0 10px var(--primary)}.wifi-item{display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:8px}.wifi-sig{font-size:0.8rem;color:var(--text-muted)}.panel{display:none;animation:fade 0.3s ease}.panel.active{display:block}@keyframes fade{from{opacity:0;transform:translateY(5px)}to{opacity:1;transform:translateY(0)}}.rec-toast{position:absolute;bottom:80px;left:50%;transform:translateX(-50%);background:rgba(16,185,129,0.9);color:white;padding:8px 16px;border-radius:20px;font-size:0.85rem;font-weight:500;opacity:0;transform:translateX(-50%) translateY(10px);transition:all 0.3s ease;pointer-events:none;backdrop-filter:blur(4px);box-shadow:0 4px 12px rgba(0,0,0,0.2);z-index:20}.rec-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}@media(max-width:600px){main{padding:1rem}.grid{grid-template-columns:1fr}}.fab{position:fixed;bottom:2rem;right:2rem;width:60px;height:60px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--accent));border:none;color:white;font-size:1.5rem;cursor:pointer;box-shadow:0 8px 24px rgba(99,102,241,0.4);transition:all 0.3s ease;z-index:999}.fab:hover{transform:scale(1.1) rotate(90deg);box-shadow:0 12px 32px rgba(99,102,241,0.6)}.quick-actions-panel{position:fixed;right:-300px;top:0;bottom:0;width:280px;background:rgba(5,5,16,0.95);backdrop-filter:blur(20px);border-left:1px solid var(--glass-border);padding:1.5rem;z-index:1000;transition:right 0.3s ease;display:flex;flex-direction:column;gap:0.5rem;overflow-y:auto}.quick-actions-panel.show{right:0;box-shadow:-10px 0 40px rgba(0,0,0,0.5)}.quick-actions-panel h4{margin:0 0 1rem 0;font-size:1.2rem;color:#fff}.quick-actions-panel .btn{width:100%;justify-content:flex-start}.perf-overlay{position:absolute;top:1rem;left:1rem;background:rgba(0,0,0,0.7);backdrop-filter:blur(10px);padding:8px 12px;border-radius:8px;font-size:0.75rem;display:flex;flex-direction:column;gap:4px;border:1px solid rgba(255,255,255,0.1);z-index:10}.perf-overlay div{display:flex;gap:8px}.perf-overlay b{color:var(--text-muted);min-width:40px}.perf-overlay span{color:var(--success);font-family:monospace}.event-list{max-height:600px;overflow-y:auto;display:flex;flex-direction:column;gap:0.5rem}.event-item{display:flex;align-items:center;gap:0.75rem;padding:0.75rem;background:rgba(255,255,255,0.03);border-radius:8px;border-left:3px solid var(--primary);font-size:0.9rem}.event-time{color:var(--text-muted);font-size:0.75rem;font-family:monospace;min-width:80px}.event-icon{font-size:1.2rem}.event-msg{flex:1;color:var(--text-main)}.recording-item{display:flex;justify-content:space-between;align-items:center;padding:1rem;background:rgba(255,255,255,0.03);border-radius:8px;margin-bottom:0.75rem;border:1px solid var(--glass-border)}.recording-item b{color:#fff;display:block;margin-bottom:4px}.recording-item small{color:var(--text-muted);font-size:0.8rem}.recording-item>div:last-child{display:flex;gap:0.5rem}.video-modal{display:none;position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.95);z-index:2000;align-items:center;justify-content:center;padding:2rem}.video-modal-content{position:relative;max-width:1200px;width:100%}.video-modal-close{position:absolute;top:-40px;right:0;background:rgba(239,68,68,0.8);border:none;color:white;width:36px;height:36px;border-radius:50%;cursor:pointer;font-size:1.2rem;font-weight:bold;transition:all 0.2s}.video-modal-close:hover{background:var(--danger);transform:scale(1.1)}input[type="checkbox"]{width:20px;height:20px;cursor:pointer;accent-color:var(--primary)}::-webkit-scrollbar{width:8px;height:8px}::-webkit-scrollbar-track{background:rgba(255,255,255,0.05);border-radius:4px}::-webkit-scrollbar-thumb{background:rgba(255,255,255,0.2);border-radius:4px}::-webkit-scrollbar-thumb:hover{background:rgba(255,255,255,0.3)}@media(max-width:600px){.fab{bottom:1rem;right:1rem;width:50px;height:50px;font-size:1.2rem}.quick-actions-panel{width:100%;right:-100%}.perf-overlay{font-size:0.65rem;padding:6px 8px}.event-item{flex-direction:column;align-items:flex-start}.event-time{min-width:auto}.recording-item{flex-direction:column;align-items:flex-start;gap:0.75rem}.recording-item>div:last-child{width:100%;flex-direction:column}.recording-item>div:last-child .btn{width:100%}}.detection-overlay{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:15}.kiosk-mode{background:#000}.kiosk-hide-ui header,.kiosk-hide-ui .tabs,.kiosk-hide-ui .fab{opacity:0;pointer-events:none;transition:opacity 0.3s}body:not(.kiosk-mode) .kiosk-hide-ui{}</style></head><body><header><div class="brand"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" /><circle cx="12" cy="13" r="4" /></svg> ESP32-CAM ONVIF <sub>Web Interface</sub></div><div class="status-pill" id="status-pill"><div class="dot pulse"></div><span id="status-text">Connecting...</span></div></header><button class="fab" onclick="toggleQuickActions()" title="Quick Actions">âš¡</button><div class="quick-actions-panel" id="quick-actions"><h4>Quick Actions</h4><button class="btn" onclick="quickReboot()">ğŸ”„ Reboot</button><button class="btn" onclick="snap()">ğŸ“¸ Snapshot</button><button class="btn" onclick="toggleRecord()">ğŸ¥ Toggle Recording</button><button class="btn" onclick="toggleFlash()">ğŸ’¡ Toggle Flash</button><button class="btn" onclick="quickToggleONVIF()">ğŸ“¡ Toggle ONVIF</button><button class="btn" onclick="applyPreset('Night')">ğŸŒ™ Night Mode</button><button class="btn" onclick="applyPreset('Daytime')">â˜€ï¸ Day Mode</button><button class="btn" onclick="toggleQuickActions()">âœ– Close</button></div><main><div class="tabs"><button class="tab-btn active" onclick="setTab('dash', event)">Dashboard</button><button class="tab-btn" onclick="setTab('cam', event)">Camera</button><button class="tab-btn" onclick="setTab('net', event)">Network</button><button class="tab-btn" onclick="setTab('events', event)">Events</button><button class="tab-btn" onclick="setTab('recordings', event)">Recordings</button><button class="tab-btn" onclick="setTab('sys', event)">System</button></div><div id="tab-dash" class="panel active"><div class="video-container glass-panel" id="vcont"><img id="stream" class="video-feed" src="" alt="Connecting..." crossorigin="anonymous"><div id="rec-toast" class="rec-toast">Recording Started</div><div class="perf-overlay"><div><b>FPS:</b><span id="perf-fps">--</span></div><div><b>Lost:</b><span id="perf-dropped">0 frames</span></div></div><div class="video-controls"><button class="btn btn-icon glass-panel" onclick="toggleStream()" title="Play/Pause">â¯</button><button class="btn btn-icon glass-panel" id="btn-record" onclick="toggleRecord()" title="Record" style="color:var(--danger)">ğŸ”´</button><button class="btn btn-icon glass-panel" onclick="snap()" title="Snapshot">ğŸ“¸</button><button class="btn btn-icon glass-panel" id="btn-flash" onclick="toggleFlash()" title="Flash">âš¡</button><button class="btn btn-icon glass-panel" onclick="toggleFS()" title="Fullscreen">â›¶</button></div></div><div class="grid"><div class="card glass-panel"><h3>ğŸ“Š System Status</h3><div class="kv-group"><span class="label">Uptime</span><span class="value" id="val-uptime">-</span></div><div class="kv-group"><span class="label">Heap Free</span><span class="value" id="val-heap">-</span></div><div class="kv-group"><span class="label">WiFi Signal</span><span class="value" id="val-rssi">-</span></div><div class="kv-group"><span class="label">Motion</span><span class="value" id="val-motion">-</span></div><div class="kv-group"><span class="label">AI Detection</span><span class="value" id="detection-count" style="color:#6366f1">0 objects</span></div><button class="btn btn-primary" style="width:100%; margin-top:0.5rem" onclick="toggleDetection()" id="btn-detection"> ğŸ¤– Enable AI Detection </button></div><div class="card glass-panel"><h3>ğŸ¥ System Info</h3><div class="kv-group"><span class="label">Resolution</span><span class="value" id="info-resolution">-</span></div><div class="kv-group"><span class="label">Codec</span><span class="value" id="info-codec">-</span></div><div class="kv-group"><span class="label">Flash Storage</span><span class="value" id="info-flash">-</span></div><div class="kv-group"><span class="label">PSRAM</span><span class="value" id="info-psram">-</span></div></div><div class="card glass-panel"><h3>ğŸ’¾ Recording</h3><div class="kv-group"><span class="label">Location</span><select class="form-control" style="width:auto" id="rec-mode" name="rec-mode"><option value="device">Device (Client)</option><option value="sd">SD Card (Server)</option></select></div><div class="kv-group" id="sd-rec-status-row" style="display:none"><span class="label">SD Status</span><span class="value" id="sd-status">Ready</span></div></div></div></div><div id="tab-cam" class="panel"><div class="grid"><div class="card glass-panel"><h3>âš¡ Quality Presets</h3><div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;"><button class="btn" onclick="applyPreset('Low')">Low (QVGA)</button><button class="btn" onclick="applyPreset('Medium')">Medium (VGA)</button><button class="btn" onclick="applyPreset('High')">High (HD)</button><button class="btn" onclick="applyPreset('Ultra')">Ultra (UXGA)</button></div></div><div class="card glass-panel"><h3>ğŸ“ Camera Profiles</h3><select class="form-control" id="profile-list" onchange="loadProfile()" style="margin-bottom: 0.5rem"><option value="">Select Profile...</option></select><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;"><button class="btn" onclick="saveProfile()">ğŸ’¾ Save</button><button class="btn" onclick="deleteProfile()">ğŸ—‘ Delete</button></div></div><div class="card glass-panel"><h3>ğŸ”§ Image Settings</h3><div class="input-group"><span class="input-label">Resolution</span><select class="form-control" id="camera-resolution" name="camera-resolution" onchange="cfg('resolution', this.value)"><option value="FRAMESIZE_UXGA">UXGA (1600x1200)</option><option value="FRAMESIZE_SXGA">SXGA (1280x1024)</option><option value="FRAMESIZE_HD">HD (1280x720)</option><option value="FRAMESIZE_VGA" selected>VGA (640x480)</option><option value="FRAMESIZE_QVGA">QVGA (320x240)</option><option value="FRAMESIZE_QQVGA">QQVGA (160x120)</option></select></div><div class="input-group"><div class="flex-row" style="margin-bottom:4px;display:flex;justify-content:space-between"><span class="input-label">Quality</span><span class="value" id="lbl-qual">12</span></div><input type="range" min="4" max="63" value="12" id="camera-quality" name="camera-quality" oninput="el('lbl-qual').innerText=this.value" onchange="cfg('quality', this.value)"></div><div class="input-group"><span class="input-label">Brightness</span><input type="range" min="-2" max="2" value="0" id="camera-brightness" name="camera-brightness" onchange="cfg('brightness', this.value)"></div><div class="input-group"><span class="input-label">Contrast</span><input type="range" min="-2" max="2" value="0" id="camera-contrast" name="camera-contrast" onchange="cfg('contrast', this.value)"></div></div><div class="card glass-panel"><h3>ğŸ¨ Advanced Controls</h3><div class="input-group"><div class="flex-row" style="margin-bottom:4px;display:flex;justify-content:space-between"><span class="input-label">Saturation</span><span class="value" id="lbl-saturation">0</span></div><input type="range" min="-2" max="2" value="0" id="inp-saturation" oninput="el('lbl-saturation').innerText=this.value" onchange="cfg('saturation', this.value)"></div><div class="input-group"><div class="flex-row" style="margin-bottom:4px;display:flex;justify-content:space-between"><span class="input-label">Exposure Level</span><span class="value" id="lbl-aelevel">0</span></div><input type="range" min="-2" max="2" value="0" id="camera-ae-level" name="camera-ae-level" oninput="el('lbl-aelevel').innerText=this.value" onchange="cfg('ae_level', this.value)"></div><div class="input-group"><div class="flex-row" style="margin-bottom:4px;display:flex;justify-content:space-between"><span class="input-label">Gain Ceiling</span><span class="value" id="lbl-gain-ceil">0</span></div><input type="range" min="0" max="6" value="0" id="camera-gain-ceiling" name="camera-gain-ceiling" oninput="el('lbl-gain-ceil').innerText=this.value" onchange="cfg('gainceiling', this.value)"></div><div class="kv-group"><span>Auto White Balance</span><input type="checkbox" id="camera-awb" name="camera-awb" checked onchange="cfg('awb', this.checked ? 1 : 0)"></div><div class="kv-group"><span>Auto Gain</span><input type="checkbox" id="camera-agc" name="camera-agc" checked onchange="cfg('agc', this.checked ? 1 : 0)"></div></div><div class="card glass-panel"><h3>âš™ï¸ Advanced</h3><div class="kv-group"><span>Auto Flash</span><input type="checkbox" id="chk-autoflash" name="chk-autoflash" onchange="api('/api/autoflash', {method:'POST', body:JSON.stringify({enabled:this.checked})})"></div><div class="kv-group"><span>Vertical Flip</span><input type="checkbox" id="camera-vflip" name="camera-vflip" onchange="cfg('vflip', this.checked ? 1 : 0)"></div><div class="kv-group"><span>H-Mirror</span><input type="checkbox" id="camera-hmirror" name="camera-hmirror" onchange="cfg('hmirror', this.checked ? 1 : 0)"></div><div class="kv-group"><span>Auto Exposure</span><input type="checkbox" id="camera-aec" name="camera-aec" checked onchange="cfg('aec', this.checked ? 1 : 0)"></div></div><div class="card glass-panel" style="border-left: 4px solid var(--primary)"><h3>ğŸ“¡ ONVIF</h3><div class="kv-group"><span>Enable ONVIF</span><input type="checkbox" id="chk-onvif" name="chk-onvif" checked onchange="api('/api/onvif/toggle', {method:'POST', body:JSON.stringify({enabled:this.checked})})"></div></div></div></div><div id="tab-net" class="panel"><div class="grid"><div class="card glass-panel"><h3>ğŸ“¡ WiFi Manager</h3><div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;"><div class="kv-group"><span class="label">SSID</span><span class="value" id="wifi-ssid">...</span></div><div class="kv-group"><span class="label">IP</span><span class="value" id="wifi-ip">...</span></div></div><button class="btn btn-primary" style="width:100%; margin-bottom: 0.5rem" onclick="scanWifi()" id="btn-scan">Scan Networks</button><div id="wifi-list"></div></div><div class="card glass-panel"><h3>ğŸ” Diagnostics</h3><button class="btn" style="width:100%; margin-bottom: 0.5rem" id="btn-ping" onclick="runPingTest()">Run Ping Test</button><div id="ping-result" style="padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.85rem;"> Click button to test latency </div></div><div class="card glass-panel"><h3>ğŸ¤ Audio</h3><div class="input-group"><span class="input-label">Source</span><select class="form-control" id="audio-src" name="audio-src" onchange="cfgBt({audioSource: parseInt(this.value)})"><option value="0">Mute</option><option value="1">Hardware I2S</option><option value="2">Bluetooth HFP</option></select></div><div class="input-group"><div class="flex-row" style="margin-bottom:4px;display:flex;justify-content:space-between"><span class="input-label">Gain</span><span class="value" id="lbl-gain">50%</span></div><input type="range" min="0" max="100" value="50" id="inp-gain" name="inp-gain" oninput="el('lbl-gain').innerText=this.value+'%'" onchange="cfgBt({gain: parseInt(this.value)})"></div></div><div class="card glass-panel"><h3>ğŸ§ Bluetooth Devices</h3><div style="background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;"><div class="kv-group"><span class="label">Status</span><span class="value" id="bt-status">Disconnected</span></div><div class="kv-group"><span class="label">Connected Device</span><span class="value" id="bt-connected-name">None</span></div></div><button class="btn btn-primary" style="width:100%; margin-bottom: 0.5rem" onclick="scanBtDevices()"> ğŸ” Scan for Devices </button><div id="bt-devices-list" style="max-height: 250px; overflow-y: auto;"></div></div><div class="card glass-panel"><h3>âš™ï¸ Bluetooth Settings</h3><div class="kv-group"><span>Enable BT</span><input type="checkbox" id="bt-enable" name="bt-enable" onchange="cfgBt({enabled:this.checked})"></div><div class="kv-group"><span>Discoverable</span><input type="checkbox" id="bt-discoverable" name="bt-discoverable" onchange="cfgBt({discoverable:this.checked})"></div><div class="kv-group"><span>Stealth Mode</span><input type="checkbox" id="bt-stealth" name="bt-stealth" onchange="cfgBt({stealth:this.checked})"></div><div class="input-group"><div class="flex-row" style="margin-bottom:4px;display:flex;justify-content:space-between"><span class="input-label">Connection Timeout</span><span class="value" id="lbl-timeout">120s</span></div><input type="range" min="30" max="600" step="30" value="120" id="inp-timeout" name="inp-timeout" oninput="el('lbl-timeout').innerText=this.value+'s'" onchange="cfgBt({timeout: parseInt(this.value)})"></div></div><div class="card glass-panel"><h3>ğŸ“ Presence Detection</h3><p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;"> Monitor if a specific device is nearby (for automation) </p><div class="input-group"><span class="input-label">Monitor MAC Address</span><input type="text" class="form-control" id="bt-mac" name="bt-mac" placeholder="XX:XX:XX:XX:XX:XX" onchange="cfgBt({mac:this.value})"></div></div></div></div><div id="tab-events" class="panel"><div class="card glass-panel" style="max-width: 800px; margin: 0 auto;"><h3>ğŸ“ Event Log</h3><button class="btn" style="margin-bottom: 1rem; width: 100%" onclick="clearEventLog()">ğŸ—‘ Clear Events</button><div id="event-list" class="event-list"></div></div></div><div id="tab-recordings" class="panel"><div class="card glass-panel" style="max-width: 900px; margin: 0 auto;"><h3>ğŸ¬ Video Recordings</h3><button class="btn" style="margin-bottom: 1rem; width: 100%" onclick="loadRecordings()">ğŸ”„ Refresh List</button><div id="recordings-list"></div></div></div><div id="video-modal" class="video-modal" onclick="if(event.target === this) closeVideoPlayer()"><div class="video-modal-content"><button class="video-modal-close" onclick="closeVideoPlayer()">âœ–</button><video id="video-player" controls style="width: 100%; max-height: 70vh;"></video></div></div><div id="tab-sys" class="panel"><div class="grid"><div class="card glass-panel"><h3>ğŸ“¦ Firmware</h3><input type="file" id="ota-file" class="form-control" accept=".bin" style="margin-bottom: 1rem"><div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow:hidden; margin-bottom: 1rem"><div id="ota-bar" style="width:0%; height:100%; background: var(--primary); transition: width 0.2s"></div></div><button class="btn btn-primary" onclick="startOTA()">Start Update</button></div><div class="card glass-panel"><h3>ğŸ’¾ SD Card</h3><div class="kv-group"><span class="label">Total</span><span class="value" id="sd-total">-</span></div><div class="kv-group"><span class="label">Used</span><span class="value" id="sd-used">-</span></div><div class="kv-group"><span class="label">Free</span><span class="value" id="sd-free">-</span></div><div class="kv-group"><span class="label">Files</span><span class="value" id="sd-files">-</span></div><div style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow:hidden; margin-top: 0.5rem"><div id="sd-progress-bar" style="width:0%; height:100%; background: var(--success); transition: width 0.3s"></div></div></div><div class="card glass-panel"><h3>âš™ï¸ Settings</h3><button class="btn btn-primary" style="width:100%; margin-bottom: 0.5rem" onclick="exportSettings()">ğŸ’¾ Export</button><div style="display: flex; gap: 0.5rem; align-items: center;"><input type="file" id="import-file" class="form-control" accept=".json" style="flex: 1"><button class="btn" onclick="importSettings()">ğŸ“¥ Import</button></div></div><div class="card glass-panel"><h3>ğŸ”§ Power</h3><button class="btn" style="margin-bottom:0.5rem; width:100%" onclick="window.open('/api/sd/list','_blank')">ğŸ“‚ Browse SD</button><button class="btn" style="margin-bottom:0.5rem; width:100%" onclick="api('/api/time',{method:'POST',body:JSON.stringify({epoch:Math.floor(Date.now()/1000)})}).then(()=>alert('Synced!'))">ğŸ•’ Sync Time</button><button class="btn" style="margin-bottom:0.5rem; width:100%" onclick="updateSDInfo()">ğŸ”„ Refresh SD</button><button class="btn" style="color:var(--danger); border-color:rgba(239,68,68,0.3); width:100%" onclick="if(confirm('Reboot?')) api('/reboot',{method:'POST'}).then(()=>alert('Rebooting...'))">ğŸ”„ Reboot</button></div></div></div></main><script>const el=i=>document.getElementById(i);const api=async (ep,opts={},timeoutMs=10000)=>{const controller=new AbortController();const timeout=setTimeout(()=>controller.abort(),timeoutMs);try{const r=await fetch(ep,{...opts,signal:controller.signal});clearTimeout(timeout);if (!r.ok){throw new Error(`HTTP ${r.status}:${r.statusText}`);}const contentType=r.headers.get('content-type');if (contentType&&contentType.includes('application/json')){return await r.json();}return await r.text();}catch (e){clearTimeout(timeout);if (e.name==='AbortError'){console.error('Request timeout:',ep);return{error:'Request timeout'};}console.error('API error:',ep,e);return{error:e.message};}};function showToast(msg){const t=el('rec-toast');t.innerText=msg;t.classList.add('show');setTimeout(()=>t.classList.remove('show'),3000);}function setTab(id,event){document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));el('tab-'+id).classList.add('active');if (event&&event.target){event.target.classList.add('active');}if (id==='net'){updateWifi();updateBt();}if (id==='sys'){updateSystemInfo();updateSDInfo();}if (id==='events') updateEventLog();if (id==='recordings') loadRecordings();}let streamStats={frames:[],bytesReceived:0,lastFrameTime:0,droppedFrames:0};function updateStreamPerformance(){const now=Date.now();streamStats.frames.push(now);if (streamStats.frames.length>30){streamStats.frames.shift();}if (streamStats.frames.length>=2){const timeSpan=(streamStats.frames[streamStats.frames.length-1]-streamStats.frames[0])/1000;const fps=streamStats.frames.length/timeSpan;if (el('perf-fps')){el('perf-fps').innerText=fps.toFixed(1)+' FPS';}}if (streamStats.lastFrameTime>0){const gap=now-streamStats.lastFrameTime;if (gap>2000){streamStats.droppedFrames++;if (el('perf-dropped')){el('perf-dropped').innerText=streamStats.droppedFrames+' frames';}}}streamStats.lastFrameTime=now;}function toggleStream(){const img=el('stream');if (img.src.includes('/stream')){img.src="";img.alt="Paused";el('status-text').innerText="Paused";}else{img.src="/stream?t="+Date.now();img.alt="Connecting...";el('status-text').innerText="Connecting...";}}function snap(){const a=document.createElement('a');a.href='/snapshot';a.download=`snap_${Date.now()}.jpg`;a.click();}const streamImg=el('stream');if (streamImg){streamImg.addEventListener('load',updateStreamPerformance);}let isRecording=false;let mediaRecorder;let recordedChunks=[];let recCanvas,recCtx,recLoop;async function toggleRecord(){const mode=el('rec-mode').value;const btn=el('btn-record');if (!isRecording){if (mode==='device'){startClientRecord();showToast("Video saving to Device â¬‡ï¸");}else{await api('/api/record',{method:'POST',body:JSON.stringify({action:'start'})});showToast("Recording to SD Card ğŸ’¾");}isRecording=true;btn.innerHTML='â¬›';btn.classList.add('pulse');}else{if (mode==='device'){stopClientRecord();}else{await api('/api/record',{method:'POST',body:JSON.stringify({action:'stop'})});showToast("Recording Stopped");}isRecording=false;btn.innerHTML='ğŸ”´';btn.classList.remove('pulse');}}function startClientRecord(){const img=el('stream');let w=img.naturalWidth;let h=img.naturalHeight;if (w===0||h===0){console.warn("Stream not fully loaded,using default 640x480");w=640;h=480;}recCanvas=document.createElement('canvas');recCanvas.width=w;recCanvas.height=h;recCtx=recCanvas.getContext('2d');console.log(`Starting Local Rec:${w}x${h}`);const draw=()=>{if (!isRecording) return;if (img.complete&&img.naturalWidth>0){recCtx.drawImage(img,0,0,w,h);}requestAnimationFrame(draw);};draw();const stream=recCanvas.captureStream(20);let mime='video/webm';let ext='webm';if (MediaRecorder.isTypeSupported('video/mp4')){mime='video/mp4';ext='mp4';}else if (MediaRecorder.isTypeSupported('video/webm;codecs=vp9')){mime='video/webm;codecs=vp9';}console.log("Recording using:",mime);try{mediaRecorder=new MediaRecorder(stream,{mimeType:mime});}catch (e){console.error("MediaRecorder fail,trying default:",e);mediaRecorder=new MediaRecorder(stream);ext='webm';}recordedChunks=[];mediaRecorder.ondataavailable=e=>{if (e.data&&e.data.size>0){console.log('Chunk received:',e.data.size,'bytes');recordedChunks.push(e.data);}};mediaRecorder.onstop=()=>{console.log('Recording stopped. Total chunks:',recordedChunks.length);if (recordedChunks.length===0){showToast('Recording failed-no data captured');return;}const blob=new Blob(recordedChunks,{type:mime});console.log('Created blob:',blob.size,'bytes');if (blob.size===0){showToast('Recording failed-empty file');return;}const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`rec_${Date.now()}.${ext}`;a.click();URL.revokeObjectURL(url);showToast(`Saved ${(blob.size/1024/1024).toFixed(2)}MB as .${ext.toUpperCase()}`);};mediaRecorder.onerror=(e)=>{console.error('MediaRecorder error:',e);showToast('Recording error occurred');};mediaRecorder.start(100);console.log('MediaRecorder started with state:',mediaRecorder.state);}function stopClientRecord(){if (mediaRecorder&&mediaRecorder.state!=='inactive'){console.log('Stopping MediaRecorder,state:',mediaRecorder.state);mediaRecorder.stop();const stream=recCanvas.captureStream();stream.getTracks().forEach(track=>track.stop());}}let flash=false;function toggleFlash(){flash=!flash;el('btn-flash').style.color=flash?'#fbbf24':'white';api('/api/flash',{method:'POST',body:JSON.stringify({state:flash})});}function toggleFS(){const c=el('vcont');if (!document.fullscreenElement){c.requestFullscreen().catch(e=>console.log(e));c.classList.add('fullscreen');}else{document.exitFullscreen();c.classList.remove('fullscreen');}}document.addEventListener('fullscreenchange',()=>{if (!document.fullscreenElement) el('vcont').classList.remove('fullscreen');});function cfg(k,v){api('/api/config',{method:'POST',body:JSON.stringify({[k]:v})});}function getSignalBars(rssi){if (rssi>-50) return{bars:'â–‚â–„â–†â–ˆ',color:'#10b981',text:'Excellent'};if (rssi>-60) return{bars:'â–‚â–„â–†â–',color:'#10b981',text:'Good'};if (rssi>-70) return{bars:'â–‚â–„â–â–',color:'#fbbf24',text:'Fair'};if (rssi>-80) return{bars:'â–‚â–â–â–',color:'#ef4444',text:'Poor'};return{bars:'â–â–â–â–',color:'#ef4444',text:'Very Poor'};}async function applyPreset(preset){await api('/api/camera/preset',{method:'POST',body:JSON.stringify({preset})});showToast(`Applied ${preset}Quality Preset`);setTimeout(()=>updateSystemInfo(),500);}async function loadProfilesList(){const d=await api('/api/profiles');if (d&&d.profiles&&el('profile-list')){const select=el('profile-list');select.innerHTML='<option value="">Select Profile...</option>';d.profiles.forEach(p=>{select.innerHTML+=`<option value="${p}">${p}</option>`;});}}async function saveProfile(){const name=prompt("Enter profile name:");if (!name) return;const result=await api('/api/profiles/save',{method:'POST',body:JSON.stringify({name})});if (result&&result.ok){showToast(`Profile "${name}" saved!`);loadProfilesList();}else{alert('Failed to save profile');}}async function loadProfile(){const select=el('profile-list');const name=select.value;if (!name) return;const result=await api('/api/profiles/load',{method:'POST',body:JSON.stringify({name})});if (result&&result.ok){showToast(`Profile "${name}" loaded!`);setTimeout(()=>updateSystemInfo(),500);}else{alert('Failed to load profile');}}async function deleteProfile(){const select=el('profile-list');const name=select.value;if (!name) return;if (!confirm(`Delete profile "${name}"?`)) return;const result=await api('/api/profiles/delete',{method:'DELETE',body:JSON.stringify({name})});if (result&&result.ok){showToast(`Profile "${name}" deleted!`);loadProfilesList();}else{alert('Failed to delete profile');}}async function updateEventLog(){const d=await api('/api/events');if (d&&d.events&&el('event-list')){const list=el('event-list');list.innerHTML='';d.events.reverse().forEach(e=>{const timeStr=new Date(e.timestamp).toLocaleTimeString();const icon=e.type==='boot'?'ğŸŸ¢':e.type==='motion'?'ğŸš¨':e.type==='recording'?'ğŸ¥':e.type==='wifi'?'ğŸ“¡':e.type==='auth'?'ğŸ”':'âš ï¸';const item=document.createElement('div');item.className='event-item';item.innerHTML=`<span class="event-time">${timeStr}</span><span class="event-icon">${icon}</span><span class="event-msg">${e.message}</span>`;list.appendChild(item);});}}async function clearEventLog(){if (!confirm('Clear all events?')) return;await api('/api/events',{method:'DELETE'});updateEventLog();showToast('Event log cleared');}async function loadRecordings(){const d=await api('/api/recordings');if (d&&d.recordings&&el('recordings-list')){const list=el('recordings-list');list.innerHTML='';if (d.recordings.length===0){list.innerHTML='<p style="color:var(--text-muted)">No recordings found</p>';return;}d.recordings.forEach(r=>{const sizeMB=(r.size/1024/1024).toFixed(2);const date=new Date(r.time*1000).toLocaleString();const item=document.createElement('div');item.className='recording-item';item.innerHTML=`<div><b>${r.name}</b><br><small>${sizeMB}MB â€¢ ${date}</small></div><div><button class="btn" onclick="playRecording('${r.name}')">â–¶ Play</button><button class="btn" onclick="deleteRecording('${r.name}')">ğŸ—‘ Delete</button></div>`;list.appendChild(item);});}}function playRecording(filename){const player=el('video-player');const modal=el('video-modal');player.src=`/api/recordings/stream?file=${encodeURIComponent(filename)}`;modal.style.display='flex';}function closeVideoPlayer(){const player=el('video-player');const modal=el('video-modal');player.pause();player.src='';modal.style.display='none';}async function deleteRecording(filename){if (!confirm(`Delete ${filename}?`)) return;const result=await api('/api/recordings/delete',{method:'DELETE',body:JSON.stringify({file:filename})});if (result&&result.ok){showToast('Recording deleted');loadRecordings();}else{alert('Failed to delete recording');}}async function runPingTest(){const btn=el('btn-ping');btn.innerText='Testing...';const start=Date.now();const result=await api('/api/network/ping');const latency=Date.now()-start;btn.innerText='Run Ping Test';if (result&&el('ping-result')){el('ping-result').innerHTML=`<b>Latency:</b>${latency}ms<br><b>RSSI:</b>${result.rssi}dBm<br><b>Status:</b>${latency<50?'âœ… Excellent':latency<100?'âœ… Good':'âš ï¸ Slow'}`;}}function toggleQuickActions(){const panel=el('quick-actions');panel.classList.toggle('show');}function quickReboot(){if (!confirm('Reboot device?')) return;api('/reboot',{method:'POST'}).then(()=>{showToast('Rebooting...');setTimeout(()=>location.reload(),3000);});}function quickToggleONVIF(){const current=el('chk-onvif').checked;el('chk-onvif').checked=!current;api('/api/onvif/toggle',{method:'POST',body:JSON.stringify({enabled:!current})});showToast(`ONVIF ${!current?'Enabled':'Disabled'}`);}async function updateSystemInfo(){const d=await api('/api/system/info');if (d){if (el('info-resolution')) el('info-resolution').innerText=d.resolution;if (el('info-codec')) el('info-codec').innerText=d.codec;if (el('info-quality')) el('info-quality').innerText=d.quality;if (el('info-flash')){const usedMB=(d.flash_used/1024/1024).toFixed(1);const totalMB=(d.flash_total/1024/1024).toFixed(1);el('info-flash').innerText=`${usedMB}/${totalMB}MB`;}if (el('info-psram')&&d.psram_total>0){const freeMB=(d.psram_free/1024/1024).toFixed(1);const totalMB=(d.psram_total/1024/1024).toFixed(1);el('info-psram').innerText=`${freeMB}/${totalMB}MB Free`;}else if (el('info-psram')){el('info-psram').innerText='N/A';}if (el('inp-saturation')){el('inp-saturation').value=d.saturation;el('lbl-saturation').innerText=d.saturation;}}}async function updateSDInfo(){const d=await api('/api/sd/info');if (d&&d.total>0){const usedGB=(d.used/1024/1024).toFixed(2);const totalGB=(d.total/1024/1024).toFixed(2);const freeGB=(d.free/1024/1024).toFixed(2);const usedPct=((d.used/d.total)*100).toFixed(1);if (el('sd-total')) el('sd-total').innerText=totalGB+' GB';if (el('sd-used')) el('sd-used').innerText=`${usedGB}GB (${usedPct}%)`;if (el('sd-free')) el('sd-free').innerText=freeGB+' GB';if (el('sd-files')) el('sd-files').innerText=d.file_count;if (el('sd-progress-bar')){el('sd-progress-bar').style.width=usedPct+'%';el('sd-progress-bar').style.backgroundColor=usedPct>90?'#ef4444':usedPct>70?'#fbbf24':'#10b981';}}}function ptzControl(action){api('/api/ptz/control',{method:'POST',body:JSON.stringify({action})});}function ptzMove(pan,tilt){api('/api/ptz/control',{method:'POST',body:JSON.stringify({pan,tilt})});}async function exportSettings(){const a=document.createElement('a');a.href='/api/settings/export';a.download=`esp32cam-config-${Date.now()}.json`;a.click();showToast("Settings Exported");}async function importSettings(){const fileInput=el('import-file');if (!fileInput.files[0]){alert('Please select a JSON file');return;}const reader=new FileReader();reader.onload=async (e)=>{const json=e.target.result;const result=await api('/api/settings/import',{method:'POST',body:json,headers:{'Content-Type':'application/json'}});if (result&&result.ok){showToast("Settings Imported Successfully");setTimeout(()=>location.reload(),1500);}else{alert('Import failed-invalid file');}};reader.readAsText(fileInput.files[0]);}async function updateWifi(){const d=await api('/api/wifi/status');if (d){el('wifi-ssid').innerText=d.ssid;el('wifi-ip').innerText=d.ip;}}async function scanWifi(){el('btn-scan').innerText="Scanning...";const d=await api('/api/wifi/scan');el('btn-scan').innerText="Scan Networks";if (d&&d.networks){el('wifi-list').innerHTML=d.networks.map(n=>`<div class="wifi-item"><div><b>${n.ssid}</b><span class="wifi-sig">${n.rssi}dBm</span></div><button class="btn" style="padding:4px 10px;font-size:0.8rem" onclick="connect('${n.ssid}')">Connect</button></div>`).join('');}}function cfgBt(obj){api('/api/bt/config',{method:'POST',body:JSON.stringify(obj)});}async function updateBt(){const d=await api('/api/bt/status');if (d){if (el('bt-enable')) el('bt-enable').checked=d.enabled;if (el('bt-stealth')) el('bt-stealth').checked=d.stealth;if (el('bt-mac')) el('bt-mac').value=d.mac;if (el('audio-src')) el('audio-src').value=d.audioSource;if (el('inp-gain')){el('inp-gain').value=d.gain;el('lbl-gain').innerText=d.gain+'%';}if (el('inp-timeout')){el('inp-timeout').value=d.timeout;el('lbl-timeout').innerText=d.timeout+'s';}}}async function scanBt(){const btn=el('btn-scan-bt');btn.innerText="Scanning...";const r=await api('/api/bt/scan');btn.innerText="Scan";let list=r;if (typeof r==='string') try{list=JSON.parse(r);}catch (e){}if (Array.isArray(list)){el('bt-scan-list').innerHTML=list.map(n=>`<div class="wifi-item"><div style="font-family:monospace"><b>${n.mac}</b><span class="wifi-sig">${n.rssi}dBm</span><br>${n.name||'Unknown'}</div><button class="btn" style="padding:4px 10px;" onclick="el('bt-mac').value='${n.mac}';cfgBt({mac:'${n.mac}'})">Select</button></div>`).join('');}else{el('bt-scan-list').innerHTML='<small style="color:var(--text-muted)">Click device to set as presence monitor</small>';}}async function scanBtDevices(){const btn=event.target;const list=el('bt-devices-list');btn.disabled=true;btn.innerText='ğŸ”„ Scanning...';list.innerHTML='<div style="text-align:center;padding:1rem;color:var(--text-muted)">Scanning for Bluetooth devices...</div>';try{const result=await api('/api/bt/scan');if (result&&result.devices&&result.devices.length>0){list.innerHTML='';result.devices.forEach(device=>{const item=document.createElement('div');item.className='bt-device-item';item.style.cssText=` background:rgba(0,0,0,0.3);padding:0.75rem;margin-bottom:0.5rem;border-radius:6px;border-left:3px solid var(--primary);`;const deviceType=getDeviceType(device.name||'Unknown');const icon=deviceType.icon;const badge=deviceType.badge;item.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;"><div style="flex:1;"><div style="font-weight:600;margin-bottom:0.25rem;">${icon}${device.name||'Unknown Device'}${badge?`<span style="background:var(--primary);padding:2px 6px;border-radius:3px;font-size:0.7rem;margin-left:0.5rem;">${badge}</span>`:''}</div><div style="font-size:0.75rem;color:var(--text-muted);">${device.address}${device.rssi?` â€¢ Signal:${device.rssi}dBm`:''}</div></div><div style="display:flex;gap:0.5rem;">${device.connected?`<button class="btn" style="background:var(--danger);font-size:0.85rem;" onclick="disconnectBtDevice('${device.address}')">Disconnect</button>`:`<button class="btn btn-primary" style="font-size:0.85rem;" onclick="connectBtDevice('${device.address}','${device.name}')">Connect</button>`}</div></div>`;list.appendChild(item);});}else{list.innerHTML='<div style="text-align:center;padding:1rem;color:var(--text-muted)">No devices found. Make sure device is in pairing mode.</div>';}}catch (err){list.innerHTML='<div style="text-align:center;padding:1rem;color:var(--danger)">Scan failed. Enable Bluetooth first.</div>';}btn.disabled=false;btn.innerText='ğŸ” Scan for Devices';}function getDeviceType(name){const nameLower=name.toLowerCase();if (nameLower.includes('headset')||nameLower.includes('airpod')||nameLower.includes('earbud')){return{icon:'ğŸ§',badge:'HEADSET'};}else if (nameLower.includes('speaker')||nameLower.includes('sound')){return{icon:'ğŸ”Š',badge:'SPEAKER'};}else if (nameLower.includes('mic')||nameLower.includes('microphone')){return{icon:'ğŸ¤',badge:'MIC'};}else if (nameLower.includes('phone')||nameLower.includes('mobile')){return{icon:'ğŸ“±',badge:'PHONE'};}return{icon:'ğŸ“±',badge:null};}async function connectBtDevice(address,name){const btn=event.target;btn.disabled=true;btn.innerText='â³ Connecting...';try{const result=await api('/api/bt/connect',{method:'POST',body:JSON.stringify({address,name})});if (result&&!result.error){showToast(`Connected to ${name}`);playSound('success');updateBtStatus();setTimeout(()=>scanBtDevices(),1000);}else{showToast('Connection failed:'+(result.error||'Unknown error'));btn.disabled=false;btn.innerText='Connect';}}catch (err){showToast('Connection error');btn.disabled=false;btn.innerText='Connect';}}async function disconnectBtDevice(address){if (!confirm('Disconnect this device?')) return;try{const result=await api('/api/bt/disconnect',{method:'POST',body:JSON.stringify({address})});if (result&&!result.error){showToast('Device disconnected');updateBtStatus();setTimeout(()=>scanBtDevices(),500);}else{showToast('Disconnect failed');}}catch (err){showToast('Disconnect error');}}async function updateBtStatus(){try{const status=await api('/api/bt/status');if (status){el('bt-status').innerText=status.connected?'Connected':'Disconnected';el('bt-status').style.color=status.connected?'var(--success)':'var(--text-muted)';if (status.device&&status.device.name){el('bt-connected-name').innerText=status.device.name;el('bt-connected-name').style.color='var(--success)';}else{el('bt-connected-name').innerText='None';el('bt-connected-name').style.color='var(--text-muted)';}if (status.connected&&status.device){el('audio-src').value='2';}}}catch (err){console.error('Failed to update BT status:',err);}}function startOTA(){const f=el('ota-file').files[0];if (!f) return alert('Select file');const fd=new FormData();fd.append("update",f);const xhr=new XMLHttpRequest();xhr.upload.onprogress=e=>el('ota-bar').style.width=Math.round((e.loaded/e.total)*100)+'%';xhr.onload=()=>alert(xhr.status===200?'Success!Rebooting...':'Failed');xhr.open("POST","/api/update");xhr.send(fd);}async function updateStatus(){const d=await api('/api/status');if (d){el('status-pill').classList.remove('offline');el('status-text').innerText="Online";el('val-uptime').innerText=Math.floor(d.uptime/60)+"m";el('val-heap').innerText=Math.round(d.heap/1024)+"KB";if (el('val-rssi')&&d.rssi!==undefined){const signal=getSignalBars(d.rssi);el('val-rssi').innerHTML=`<span style="color:${signal.color}">${signal.bars}</span>${d.rssi}dBm`;}if (el('val-motion')){el('val-motion').innerText=d.motion?"Detected":"None";el('val-motion').style.color=d.motion?'#ef4444':'#10b981';}if (el('chk-autoflash')) el('chk-autoflash').checked=d.autoflash;if (el('chk-onvif')) el('chk-onvif').checked=d.onvif_enabled;const sdOpt=el('rec-mode')?.querySelector('option[value="sd"]');if (sdOpt){if (!d.sd_mounted){sdOpt.disabled=true;sdOpt.innerText="SD Card (Not Found)";if (el('rec-mode').value==='sd') el('rec-mode').value='device';}else{sdOpt.disabled=false;sdOpt.innerText="SD Card (Server)";}}if (el('rec-mode')&&el('rec-mode').value==='sd'){el('sd-rec-status-row').style.display='flex';el('sd-status').innerText=d.recording?"Recording...":"Ready";if (d.recording&&!isRecording){isRecording=true;el('btn-record').innerHTML='â¬›';el('btn-record').classList.add('pulse');}else if (!d.recording&&isRecording&&el('rec-mode').value==='sd'){isRecording=false;el('btn-record').innerHTML='ğŸ”´';el('btn-record').classList.remove('pulse');}}else if (el('sd-rec-status-row')){el('sd-rec-status-row').style.display='none';}}else{el('status-pill').classList.add('offline');el('status-text').innerText="Offline";}}setInterval(updateStatus,2000);streamImg.onerror=()=>{console.log("Stream error/disconnect. Retrying...");el('status-text').innerText="Reconnecting...";el('status-pill').classList.add('offline');setTimeout(()=>{if (streamImg.src.includes('/stream')){streamImg.src='/stream?t='+Date.now();}},2000);};streamImg.onload=()=>{el('status-pill').classList.remove('offline');el('status-text').innerText="Online";}function cleanup(){if (isRecording&&mediaRecorder){stopClientRecord();}if (objectDetection.isEnabled){objectDetection.stopDetection();}if (timeLapse.isRecording){timeLapse.stop();}const highestId=setInterval(()=>{},0);for (let i=0;i<highestId;i++){clearInterval(i);}console.log('Cleanup completed');}window.addEventListener('beforeunload',cleanup);window.onload=()=>{el('stream').src='/stream?t='+Date.now();updateStatus();updateWifi();updateSystemInfo();loadProfilesList();initClientSideFeatures();}const snapshotGallery={maxSnapshots:50,init(){if (!localStorage.getItem('esp32cam_snapshots')){localStorage.setItem('esp32cam_snapshots',JSON.stringify([]));}},saveSnapshot(){const img=el('stream');const canvas=document.createElement('canvas');canvas.width=img.naturalWidth||640;canvas.height=img.naturalHeight||480;const ctx=canvas.getContext('2d');ctx.drawImage(img,0,0);const dataURL=canvas.toDataURL('image/jpeg',0.9);const snapshots=this.getAll();snapshots.push({id:'snap_'+Date.now(),timestamp:Date.now(),dataURL:dataURL,resolution:`${canvas.width}x${canvas.height}`});if (snapshots.length>this.maxSnapshots){snapshots.shift();}localStorage.setItem('esp32cam_snapshots',JSON.stringify(snapshots));showToast('Snapshot saved to gallery');playSound('snapshot');},getAll(){return JSON.parse(localStorage.getItem('esp32cam_snapshots')||'[]');},delete(id){const snapshots=this.getAll().filter(s=>s.id!==id);localStorage.setItem('esp32cam_snapshots',JSON.stringify(snapshots));},clear(){localStorage.setItem('esp32cam_snapshots',JSON.stringify([]));}};function openGallery(){const modal=el('gallery-modal');const grid=el('gallery-grid');const snapshots=snapshotGallery.getAll();grid.innerHTML='';if (snapshots.length===0){grid.innerHTML='<p style="color:var(--text-muted);grid-column:1/-1;text-align:center">No snapshots yet. Press S to capture!</p>';}else{snapshots.reverse().forEach(snap=>{const item=document.createElement('div');item.className='gallery-item';item.innerHTML=`<img src="${snap.dataURL}" alt="Snapshot"><div class="gallery-item-actions"><button class="btn-mini" onclick="viewSnapshot('${snap.id}')">View</button><button class="btn-mini" onclick="downloadSnapshot('${snap.id}')">Download</button><button class="btn-mini" onclick="deleteSnapshot('${snap.id}')">Delete</button></div><small>${new Date(snap.timestamp).toLocaleString()}</small>`;grid.appendChild(item);});}modal.style.display='flex';}function closeGallery(){el('gallery-modal').style.display='none';}function viewSnapshot(id){const snap=snapshotGallery.getAll().find(s=>s.id===id);if (snap){const viewer=el('snapshot-viewer');el('snapshot-view-img').src=snap.dataURL;viewer.style.display='flex';}}function closeSnapshotViewer(){el('snapshot-viewer').style.display='none';}function downloadSnapshot(id){const snap=snapshotGallery.getAll().find(s=>s.id===id);if (snap){const a=document.createElement('a');a.href=snap.dataURL;a.download=`snapshot_${snap.id}.jpg`;a.click();}}function deleteSnapshot(id){if (confirm('Delete this snapshot?')){snapshotGallery.delete(id);openGallery();}}function clearAllSnapshots(){if (confirm('Delete all snapshots?')){snapshotGallery.clear();closeGallery();showToast('All snapshots deleted');}}const keyboardShortcuts={enabled:true,init(){document.addEventListener('keydown',(e)=>{if (!this.enabled) return;if (e.target.tagName==='INPUT'||e.target.tagName==='TEXTAREA') return;if (e.ctrlKey||e.altKey||e.metaKey) return;const key=e.key.toLowerCase();switch (key){case ' ':e.preventDefault();toggleStream();break;case 's':e.preventDefault();snapshotGallery.saveSnapshot();break;case 'r':e.preventDefault();toggleRecord();break;case 'f':e.preventDefault();toggleFlash();break;case 'k':e.preventDefault();toggleFS();break;case 'g':e.preventDefault();openGallery();break;case 'q':e.preventDefault();toggleQuickActions();break;case 'p':e.preventDefault();togglePiP();break;case 'm':e.preventDefault();toggleKioskMode();break;case 'd':e.preventDefault();toggleDetection();break;case '?':e.preventDefault();showShortcutsHelp();break;case 'escape':closeAllModals();break;case '1':setTabByIndex(0);break;case '2':setTabByIndex(1);break;case '3':setTabByIndex(2);break;case '4':setTabByIndex(3);break;case '5':setTabByIndex(4);break;case '6':setTabByIndex(5);break;}});}};function setTabByIndex(index){const tabs=['dash','cam','net','events','recordings','sys'];if (tabs[index]){document.querySelectorAll('.tab-btn')[index]?.click();}}function closeAllModals(){el('gallery-modal').style.display='none';el('snapshot-viewer').style.display='none';el('video-modal').style.display='none';el('shortcuts-modal').style.display='none';el('comparison-modal').style.display='none';}function showShortcutsHelp(){el('shortcuts-modal').style.display='flex';}function closeShortcutsHelp(){el('shortcuts-modal').style.display='none';}async function togglePiP(){const video=el('stream');try{if (document.pictureInPictureElement){await document.exitPictureInPicture();showToast('PiP disabled');}else{const videoEl=document.createElement('video');videoEl.src=video.src;videoEl.autoplay=true;videoEl.muted=true;await videoEl.requestPictureInPicture();showToast('PiP enabled');}}catch (err){console.error('PiP failed:',err);showToast('PiP not supported');}}const videoFilters={brightness:100,contrast:100,saturation:100,hue:0,blur:0,grayscale:0,sepia:0,invert:0,init(){const saved=localStorage.getItem('esp32cam_filters');if (saved){Object.assign(this,JSON.parse(saved));}this.apply();},apply(){const img=el('stream');img.style.filter=` brightness(${this.brightness}%) contrast(${this.contrast}%) saturate(${this.saturation}%) hue-rotate(${this.hue}deg) blur(${this.blur}px) grayscale(${this.grayscale}%) sepia(${this.sepia}%) invert(${this.invert}%) `;localStorage.setItem('esp32cam_filters',JSON.stringify(this));},reset(){this.brightness=100;this.contrast=100;this.saturation=100;this.hue=0;this.blur=0;this.grayscale=0;this.sepia=0;this.invert=0;this.apply();}};function updateFilter(filter,value){videoFilters[filter]=value;videoFilters.apply();el('lbl-filter-'+filter).innerText=value+(filter==='hue'?'Â°':'%');}function resetFilters(){videoFilters.reset();Object.keys(videoFilters).forEach(filter=>{const slider=el('filter-'+filter);if (slider){slider.value=videoFilters[filter];el('lbl-filter-'+filter).innerText=videoFilters[filter]+(filter==='hue'?'Â°':'%');}});}let kioskMode=false;let kioskTimeout;function toggleKioskMode(){if (!kioskMode){enterKioskMode();}else{exitKioskMode();}}function enterKioskMode(){document.documentElement.requestFullscreen();document.body.classList.add('kiosk-mode');kioskMode=true;resetKioskTimeout();document.addEventListener('mousemove',resetKioskTimeout);showToast('Kiosk Mode-Press M or Esc to exit');}function exitKioskMode(){if (document.fullscreenElement){document.exitFullscreen();}document.body.classList.remove('kiosk-mode');kioskMode=false;document.removeEventListener('mousemove',resetKioskTimeout);clearTimeout(kioskTimeout);}function resetKioskTimeout(){document.body.classList.remove('kiosk-hide-ui');clearTimeout(kioskTimeout);kioskTimeout=setTimeout(()=>{document.body.classList.add('kiosk-hide-ui');},3000);}document.addEventListener('fullscreenchange',()=>{if (!document.fullscreenElement&&kioskMode){exitKioskMode();}});const comparisonTool={beforeImage:null,afterImage:null,captureBefore(){const img=el('stream');const canvas=document.createElement('canvas');canvas.width=img.naturalWidth||640;canvas.height=img.naturalHeight||480;const ctx=canvas.getContext('2d');ctx.drawImage(img,0,0);this.beforeImage=canvas.toDataURL('image/jpeg',0.9);showToast('Before image captured');},captureAfter(){const img=el('stream');const canvas=document.createElement('canvas');canvas.width=img.naturalWidth||640;canvas.height=img.naturalHeight||480;const ctx=canvas.getContext('2d');ctx.drawImage(img,0,0);this.afterImage=canvas.toDataURL('image/jpeg',0.9);showToast('After image captured');},showComparison(){if (!this.beforeImage||!this.afterImage){alert('Capture both before and after images first');return;}el('comparison-before').src=this.beforeImage;el('comparison-after').src=this.afterImage;el('comparison-modal').style.display='flex';}};function captureComparisonBefore(){comparisonTool.captureBefore();}function captureComparisonAfter(){comparisonTool.captureAfter();}function showComparison(){comparisonTool.showComparison();}function closeComparison(){el('comparison-modal').style.display='none';}function updateComparisonSlider(value){el('comparison-after').style.clipPath=`inset(0 ${100-value}%0 0)`;}const connectionHistory={data:[],maxPoints:43200,init(){const saved=localStorage.getItem('esp32cam_history');if (saved){this.data=JSON.parse(saved);const cutoff=Date.now()-(24*60*60*1000);this.data=this.data.filter(d=>d.timestamp>cutoff);}},add(rssi,fps,online){this.data.push({timestamp:Date.now(),rssi:rssi,fps:fps,online:online});if (this.data.length>this.maxPoints){this.data.shift();}localStorage.setItem('esp32cam_history',JSON.stringify(this.data));},drawGraph(){const canvas=el('timeline-canvas');if (!canvas) return;const ctx=canvas.getContext('2d');const width=canvas.width;const height=canvas.height;ctx.clearRect(0,0,width,height);if (this.data.length<2) return;ctx.strokeStyle='#10b981';ctx.lineWidth=2;ctx.beginPath();this.data.forEach((d,i)=>{const x=(i/this.data.length)*width;const y=height-((d.rssi+100)/50*height);if (i===0) ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();ctx.strokeStyle='#6366f1';ctx.lineWidth=2;ctx.beginPath();this.data.forEach((d,i)=>{const x=(i/this.data.length)*width;const y=height-(d.fps/30*height);if (i===0) ctx.moveTo(x,y);else ctx.lineTo(x,y);});ctx.stroke();}};const soundSystem={enabled:true,volume:0.5,init(){const prefs=JSON.parse(localStorage.getItem('esp32cam_preferences')||'{}');this.enabled=prefs.soundsEnabled!==false;this.volume=prefs.soundVolume||0.5;},play(type){if (!this.enabled) return;const audioCtx=new (window.AudioContext||window.webkitAudioContext)();const oscillator=audioCtx.createOscillator();const gainNode=audioCtx.createGain();oscillator.connect(gainNode);gainNode.connect(audioCtx.destination);gainNode.gain.value=this.volume;const frequencies={snapshot:800,recording:600,motion:1000,error:400,success:1200};oscillator.frequency.value=frequencies[type]||800;oscillator.type='sine';oscillator.start();oscillator.stop(audioCtx.currentTime+0.1);},save(){const prefs=JSON.parse(localStorage.getItem('esp32cam_preferences')||'{}');prefs.soundsEnabled=this.enabled;prefs.soundVolume=this.volume;localStorage.setItem('esp32cam_preferences',JSON.stringify(prefs));}};function playSound(type){soundSystem.play(type);}function toggleSounds(){soundSystem.enabled=!soundSystem.enabled;soundSystem.save();showToast(soundSystem.enabled?'Sounds enabled':'Sounds disabled');}const timeLapse={frames:[],isRecording:false,interval:null,intervalMs:1000,start(){this.frames=[];this.isRecording=true;this.interval=setInterval(()=>{this.captureFrame();},this.intervalMs);showToast(`Time-lapse started (${this.intervalMs/1000}s interval)`);},stop(){this.isRecording=false;clearInterval(this.interval);showToast(`Time-lapse stopped (${this.frames.length}frames)`);},captureFrame(){const img=el('stream');const canvas=document.createElement('canvas');canvas.width=img.naturalWidth||640;canvas.height=img.naturalHeight||480;const ctx=canvas.getContext('2d');ctx.drawImage(img,0,0);this.frames.push(canvas.toDataURL('image/jpeg',0.8));if (el('timelapse-count')){el('timelapse-count').innerText=this.frames.length+' frames';}if (this.frames.length>=100){this.stop();showToast('Max frames reached (100)');}},export(){if (this.frames.length<2){alert('Need at least 2 frames');return;}showToast('Exporting time-lapse...');const canvas=document.createElement('canvas');canvas.width=640;canvas.height=480;const ctx=canvas.getContext('2d');const stream=canvas.captureStream(10);const recorder=new MediaRecorder(stream);const chunks=[];recorder.ondataavailable=e=>chunks.push(e.data);recorder.onstop=()=>{const blob=new Blob(chunks,{type:'video/webm'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`timelapse_${Date.now()}.webm`;a.click();URL.revokeObjectURL(url);showToast('Time-lapse exported');};recorder.start();let frameIndex=0;const drawInterval=setInterval(()=>{if (frameIndex>=this.frames.length){clearInterval(drawInterval);recorder.stop();return;}const img=new Image();img.onload=()=>{ctx.drawImage(img,0,0,640,480);};img.src=this.frames[frameIndex];frameIndex++;},100);}};function initClientSideFeatures(){snapshotGallery.init();keyboardShortcuts.init();videoFilters.init();connectionHistory.init();soundSystem.init();setInterval(()=>{const rssi=parseInt(el('val-rssi')?.innerText)||-70;const fps=parseFloat(el('perf-fps')?.innerText)||20;const online=!el('status-pill')?.classList.contains('offline');connectionHistory.add(rssi,fps,online);},2000);setInterval(()=>{connectionHistory.drawGraph();},5000);console.log('Client-side features initialized');}const objectDetection={model:null,isEnabled:false,isLoading:false,detectionCanvas:null,detectionCtx:null,detectionLoop:null,lastDetections:[],async init(){if (this.model) return;this.isLoading=true;showToast('Loading AI model...');try{this.model=await cocoSsd.load();showToast('AI model loaded!Press D to enable detection');this.isLoading=false;this.createOverlay();}catch (err){console.error('Failed to load model:',err);showToast('AI model failed to load');this.isLoading=false;}},createOverlay(){const container=el('vcont');if (!this.detectionCanvas){this.detectionCanvas=document.createElement('canvas');this.detectionCanvas.id='detection-canvas';this.detectionCanvas.className='detection-overlay';container.appendChild(this.detectionCanvas);this.detectionCtx=this.detectionCanvas.getContext('2d');}},async toggle(){if (!this.model){await this.init();return;}this.isEnabled=!this.isEnabled;const btn=el('btn-detection');if (btn){if (this.isEnabled){btn.innerText='ğŸ¤– Disable AI Detection';btn.style.background='#ef4444';}else{btn.innerText='ğŸ¤– Enable AI Detection';btn.style.background='';}}if (this.isEnabled){this.startDetection();showToast('Object detection ON');playSound('success');}else{this.stopDetection();showToast('Object detection OFF');}},startDetection(){const img=el('stream');const canvas=this.detectionCanvas;const ctx=this.detectionCtx;const updateCanvasSize=()=>{canvas.width=img.clientWidth;canvas.height=img.clientHeight;};updateCanvasSize();window.addEventListener('resize',updateCanvasSize);const detect=async ()=>{if (!this.isEnabled) return;try{const predictions=await this.model.detect(img);this.lastDetections=predictions;ctx.clearRect(0,0,canvas.width,canvas.height);predictions.forEach(prediction=>{const [x,y,width,height]=prediction.bbox;const scaleX=canvas.width/img.naturalWidth;const scaleY=canvas.height/img.naturalHeight;const scaledX=x*scaleX;const scaledY=y*scaleY;const scaledWidth=width*scaleX;const scaledHeight=height*scaleY;const color='#10b981';const cornerLength=20;ctx.shadowColor=color;ctx.shadowBlur=10;ctx.strokeStyle=color;ctx.lineWidth=4;ctx.strokeRect(scaledX,scaledY,scaledWidth,scaledHeight);ctx.lineWidth=5;ctx.shadowBlur=15;ctx.beginPath();ctx.moveTo(scaledX,scaledY+cornerLength);ctx.lineTo(scaledX,scaledY);ctx.lineTo(scaledX+cornerLength,scaledY);ctx.stroke();ctx.beginPath();ctx.moveTo(scaledX+scaledWidth-cornerLength,scaledY);ctx.lineTo(scaledX+scaledWidth,scaledY);ctx.lineTo(scaledX+scaledWidth,scaledY+cornerLength);ctx.stroke();ctx.beginPath();ctx.moveTo(scaledX,scaledY+scaledHeight-cornerLength);ctx.lineTo(scaledX,scaledY+scaledHeight);ctx.lineTo(scaledX+cornerLength,scaledY+scaledHeight);ctx.stroke();ctx.beginPath();ctx.moveTo(scaledX+scaledWidth-cornerLength,scaledY+scaledHeight);ctx.lineTo(scaledX+scaledWidth,scaledY+scaledHeight);ctx.lineTo(scaledX+scaledWidth,scaledY+scaledHeight-cornerLength);ctx.stroke();ctx.shadowBlur=0;ctx.fillStyle='rgba(16,185,129,0.1)';ctx.fillRect(scaledX,scaledY,scaledWidth,scaledHeight);const label=`${prediction.class}${(prediction.score*100).toFixed(0)}%`;ctx.font='bold 16px Inter,sans-serif';const textWidth=ctx.measureText(label).width;ctx.fillStyle=color;ctx.fillRect(scaledX,scaledY-30,textWidth+16,30);ctx.fillStyle='#000';ctx.fillText(label,scaledX+8,scaledY-9);});if (el('detection-count')){el('detection-count').innerText=predictions.length+' objects';}}catch (err){console.error('Detection error:',err);}this.detectionLoop=requestAnimationFrame(detect);};detect();},stopDetection(){if (this.detectionLoop){cancelAnimationFrame(this.detectionLoop);this.detectionLoop=null;}if (this.detectionCtx&&this.detectionCanvas){this.detectionCtx.clearRect(0,0,this.detectionCanvas.width,this.detectionCanvas.height);}if (el('detection-count')){el('detection-count').innerText='0 objects';}},getDetectedObjects(){return this.lastDetections.map(d=>({class:d.class,confidence:(d.score*100).toFixed(1)+'%',bbox:d.bbox}));}};function toggleDetection(){objectDetection.toggle();}</script></body></html>)rawliteral";
