<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>ESP32-CAM ONVIF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#000000">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:,">
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <header>
    <div class="brand">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
        <circle cx="12" cy="13" r="4" />
      </svg>
      ESP32-CAM ONVIF <sub>Web Interface</sub>
    </div>
    <div class="status-pill" id="status-pill">
      <div class="dot pulse"></div>
      <span id="status-text">Connecting...</span>
    </div>
  </header>

  <main>
    <div class="tabs">
      <button class="tab-btn active" onclick="setTab('dash')">Dashboard</button>
      <button class="tab-btn" onclick="setTab('cam')">Camera</button>
      <button class="tab-btn" onclick="setTab('net')">Network</button>
      <button class="tab-btn" onclick="setTab('sys')">System</button>
    </div>

    <!-- PANEL: DASHBOARD -->
    <div id="tab-dash" class="panel active">
      <div class="video-container glass-panel" id="vcont">
        <img id="stream" class="video-feed" src="" alt="Connecting..." crossorigin="anonymous">
        <div id="rec-toast" class="rec-toast">Recording Started</div>
        <div class="video-controls">
          <button class="btn btn-icon glass-panel" onclick="toggleStream()" title="Play/Pause">‚èØ</button>
          <button class="btn btn-icon glass-panel" id="btn-record" onclick="toggleRecord()" title="Record"
            style="color:var(--danger)">üî¥</button>
          <button class="btn btn-icon glass-panel" onclick="snap()" title="Snapshot">üì∏</button>
          <button class="btn btn-icon glass-panel" id="btn-flash" onclick="toggleFlash()" title="Flash">‚ö°</button>
          <button class="btn btn-icon glass-panel" onclick="toggleFS()" title="Fullscreen">‚õ∂</button>
        </div>
      </div>

      <div class="grid">
        <div class="card glass-panel">
          <h3>System Status</h3>
          <div class="kv-group"><span class="label">Uptime</span> <span class="value" id="val-uptime">-</span></div>
          <div class="kv-group"><span class="label">Heap Free</span> <span class="value" id="val-heap">-</span></div>
          <div class="kv-group"><span class="label">WiFi Signal</span> <span class="value" id="val-rssi">-</span></div>
          <div class="kv-group"><span class="label">Motion</span> <span class="value" id="val-motion">-</span></div>
        </div>

        <div class="card glass-panel">
          <h3>Recording Settings</h3>
          <div class="kv-group">
            <span class="label">Storage Location</span>
            <select class="form-control" style="width:auto" id="rec-mode">
              <option value="device">Device (Client)</option>
              <option value="sd">SD Card (Server)</option>
            </select>
          </div>
          <div class="kv-group" id="sd-rec-status-row" style="display:none">
            <span class="label">SD Status</span>
            <span class="value" id="sd-status">Ready</span>
          </div>
        </div>
      </div>
    </div>

    <!-- PANEL: CAMERA -->
    <div id="tab-cam" class="panel">
      <div class="grid">
        <div class="card glass-panel">
          <h3>Image Settings</h3>
          <div class="input-group">
            <span class="input-label">Resolution</span>
            <select class="form-control" onchange="cfg('resolution', this.value)">
              <option value="FRAMESIZE_UXGA">UXGA (1600x1200)</option>
              <option value="FRAMESIZE_SXGA">SXGA (1280x1024)</option>
              <option value="FRAMESIZE_HD">HD (1280x720)</option>
              <option value="FRAMESIZE_VGA" selected>VGA (640x480) [Rec.]</option>
              <option value="FRAMESIZE_QVGA">QVGA (320x240)</option>
              <option value="FRAMESIZE_QQVGA">QQVGA (160x120)</option>
            </select>
          </div>

          <div class="input-group">
            <div class="flex-row" style="margin-bottom:4px;display:flex;justify-content:space-between">
              <span class="input-label">Quality (Lower is Better)</span>
              <span class="value" id="lbl-qual">12</span>
            </div>
            <input type="range" min="4" max="63" value="12" oninput="el('lbl-qual').innerText=this.value"
              onchange="cfg('quality', this.value)">
          </div>

          <div class="input-group">
            <span class="input-label">Brightness</span>
            <input type="range" min="-2" max="2" value="0" onchange="cfg('brightness', this.value)">
          </div>
          <div class="input-group">
            <span class="input-label">Contrast</span>
            <input type="range" min="-2" max="2" value="0" onchange="cfg('contrast', this.value)">
          </div>
        </div>

        <div class="card glass-panel">
          <h3>Advanced</h3>
          <div class="kv-group">
            <span>Auto Flash (Night Mode)</span>
            <input type="checkbox" id="chk-autoflash"
              onchange="api('/api/autoflash', {method:'POST', body:JSON.stringify({enabled:this.checked})})">
          </div>
          <div class="kv-group">
            <span>Vertical Flip</span>
            <input type="checkbox" onchange="cfg('vflip', this.checked ? 1 : 0)">
          </div>
          <div class="kv-group">
            <span>Horizontal Mirror</span>
            <input type="checkbox" onchange="cfg('hmirror', this.checked ? 1 : 0)">
          </div>
          <div class="kv-group">
            <span>Auto Exposure</span>
            <input type="checkbox" checked onchange="cfg('aec', this.checked ? 1 : 0)">
          </div>
        </div>

        <div class="card glass-panel" style="border-left: 4px solid var(--primary)">
          <h3>ONVIF Settings</h3>
          <div class="kv-group">
            <span>Enable ONVIF Service</span>
            <input type="checkbox" id="chk-onvif" checked
              onchange="api('/api/onvif/toggle', {method:'POST', body:JSON.stringify({enabled:this.checked})})">
          </div>
        </div>
      </div>
    </div>

    <!-- PANEL: NETWORK -->
    <div id="tab-net" class="panel">
      <div class="card glass-panel" style="max-width: 600px; margin: 0 auto;">
        <h3>WiFi Manager</h3>

        <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
          <div class="kv-group"><span class="label">SSID</span> <span class="value" id="wifi-ssid">...</span></div>
          <div class="kv-group"><span class="label">IP Address</span> <span class="value" id="wifi-ip">...</span></div>
        </div>

        <button class="btn btn-primary" style="width:100%" onclick="scanWifi()" id="btn-scan">Scan Networks</button>
        <div id="wifi-list" style="margin-top: 1rem;"></div>
      </div>
    </div>

    <!-- PANEL: SYSTEM -->
    <div id="tab-sys" class="panel">
      <div class="grid">
        <div class="card glass-panel">
          <h3>Firmware Update</h3>
          <p class="label">Upload .bin file to update firmware</p>
          <input type="file" id="ota-file" class="form-control" accept=".bin" style="margin-bottom: 1rem">
          <div
            style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow:hidden; margin-bottom: 1rem">
            <div id="ota-bar" style="width:0%; height:100%; background: var(--primary); transition: width 0.2s"></div>
          </div>
          <button class="btn btn-primary" onclick="startOTA()">Start Update</button>
        </div>

        <div class="card glass-panel">
          <h3>Power & Storage</h3>
          <button class="btn" style="margin-bottom:0.5rem" onclick="window.open('/api/sd/list','_blank')">üìÇ Browse SD
            Card</button>
          <button class="btn" style="margin-bottom:0.5rem"
            onclick="api('/api/time',{method:'POST',body:JSON.stringify({epoch:Math.floor(Date.now()/1000)})}).then(()=>alert('Synced!'))">üïí
            Sync Time</button>
          <button class="btn" style="color:var(--danger); border-color:rgba(239,68,68,0.3)"
            onclick="if(confirm('Reboot device?')) api('/reboot',{method:'POST'}).then(()=>alert('Rebooting... Device will restart.'))">üîÑ
            Reboot Device</button>
        </div>
      </div>
    </div>

  </main>

  <script src="app.js"></script>
</body>

</html>