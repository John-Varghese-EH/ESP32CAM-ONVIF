<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>ESP32-CAM ONVIF</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="theme-color" content="#000000">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="icon" href="data:,">
  <!-- TensorFlow.js for Object Detection -->
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@4.11.0"></script>
  <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd@2.2.3"></script>
  <link rel="stylesheet" href="style.css">
</head>

<body>

  <header>
    <div class="brand">
      <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z" />
        <circle cx="12" cy="13" r="4" />
      </svg>
      ESP32-CAM ONVIF <sub>Web Interface</sub>
    </div>
    <div class="status-pill" id="status-pill">
      <div class="dot pulse"></div>
      <span id="status-text">Connecting...</span>
    </div>
  </header>

  <!-- Quick Actions FAB -->
  <button class="fab" onclick="toggleQuickActions()" title="Quick Actions">âš¡</button>

  <div class="quick-actions-panel" id="quick-actions">
    <h4>Quick Actions</h4>
    <button class="btn" onclick="quickReboot()">ğŸ”„ Reboot</button>
    <button class="btn" onclick="snap()">ğŸ“¸ Snapshot</button>
    <button class="btn" onclick="toggleRecord()">ğŸ¥ Toggle Recording</button>
    <button class="btn" onclick="toggleFlash()">ğŸ’¡ Toggle Flash</button>
    <button class="btn" onclick="quickToggleONVIF()">ğŸ“¡ Toggle ONVIF</button>
    <button class="btn" onclick="applyPreset('Night')">ğŸŒ™ Night Mode</button>
    <button class="btn" onclick="applyPreset('Daytime')">â˜€ï¸ Day Mode</button>
    <button class="btn" onclick="toggleQuickActions()">âœ– Close</button>
  </div>

  <main>
    <div class="tabs">
      <button class="tab-btn active" onclick="setTab('dash', event)">Dashboard</button>
      <button class="tab-btn" onclick="setTab('cam', event)">Camera</button>
      <button class="tab-btn" onclick="setTab('net', event)">Network</button>
      <button class="tab-btn" onclick="setTab('events', event)">Events</button>
      <button class="tab-btn" onclick="setTab('recordings', event)">Recordings</button>
      <button class="tab-btn" onclick="setTab('sys', event)">System</button>
    </div>

    <!-- PANEL: DASHBOARD -->
    <div id="tab-dash" class="panel active">
      <div class="video-container glass-panel" id="vcont">
        <img id="stream" class="video-feed" src="" alt="Connecting..." crossorigin="anonymous">
        <div id="rec-toast" class="rec-toast">Recording Started</div>

        <!-- Stream Performance Overlay -->
        <div class="perf-overlay">
          <div><b>FPS:</b> <span id="perf-fps">--</span></div>
          <div><b>Lost:</b> <span id="perf-dropped">0 frames</span></div>
        </div>

        <div class="video-controls">
          <button class="btn btn-icon glass-panel" onclick="toggleStream()" title="Play/Pause">â¯</button>
          <button class="btn btn-icon glass-panel" id="btn-record" onclick="toggleRecord()" title="Record"
            style="color:var(--danger)">ğŸ”´</button>
          <button class="btn btn-icon glass-panel" onclick="snap()" title="Snapshot">ğŸ“¸</button>
          <button class="btn btn-icon glass-panel" id="btn-flash" onclick="toggleFlash()" title="Flash">âš¡</button>
          <button class="btn btn-icon glass-panel" onclick="toggleFS()" title="Fullscreen">â›¶</button>
        </div>
      </div>

      <div class="grid">
        <div class="card glass-panel">
          <h3>ğŸ“Š System Status</h3>
          <div class="kv-group"><span class="label">Uptime</span> <span class="value" id="val-uptime">-</span></div>
          <div class="kv-group"><span class="label">Heap Free</span> <span class="value" id="val-heap">-</span></div>
          <div class="kv-group"><span class="label">WiFi Signal</span> <span class="value" id="val-rssi">-</span></div>
          <div class="kv-group"><span class="label">Motion</span> <span class="value" id="val-motion">-</span></div>
          <div class="kv-group">
            <span class="label">AI Detection</span>
            <span class="value" id="detection-count" style="color:#6366f1">0 objects</span>
          </div>
          <button class="btn btn-primary" style="width:100%; margin-top:0.5rem" onclick="toggleDetection()"
            id="btn-detection">
            ğŸ¤– Enable AI Detection
          </button>
        </div>

        <div class="card glass-panel">
          <h3>ğŸ¥ System Info</h3>
          <div class="kv-group"><span class="label">Resolution</span> <span class="value" id="info-resolution">-</span>
          </div>
          <div class="kv-group"><span class="label">Codec</span> <span class="value" id="info-codec">-</span></div>
          <div class="kv-group"><span class="label">Flash Storage</span> <span class="value" id="info-flash">-</span>
          </div>
          <div class="kv-group"><span class="label">PSRAM</span> <span class="value" id="info-psram">-</span></div>
        </div>

        <div class="card glass-panel">
          <h3>ğŸ’¾ Recording</h3>
          <div class="kv-group">
            <span class="label">Location</span>
            <select class="form-control" style="width:auto" id="rec-mode" name="rec-mode">
              <option value="device">Device (Client)</option>
              <option value="sd">SD Card (Server)</option>
            </select>
          </div>
          <div class="kv-group" id="sd-rec-status-row" style="display:none">
            <span class="label">SD Status</span>
            <span class="value" id="sd-status">Ready</span>
          </div>
        </div>
      </div>
    </div>

    <!-- PANEL: CAMERA -->
    <div id="tab-cam" class="panel">
      <div class="grid">
        <div class="card glass-panel">
          <h3>âš¡ Quality Presets</h3>
          <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.5rem;">
            <button class="btn" onclick="applyPreset('Low')">Low (QVGA)</button>
            <button class="btn" onclick="applyPreset('Medium')">Medium (VGA)</button>
            <button class="btn" onclick="applyPreset('High')">High (HD)</button>
            <button class="btn" onclick="applyPreset('Ultra')">Ultra (UXGA)</button>
          </div>
        </div>

        <div class="card glass-panel">
          <h3>ğŸ“ Camera Profiles</h3>
          <select class="form-control" id="profile-list" onchange="loadProfile()" style="margin-bottom: 0.5rem">
            <option value="">Select Profile...</option>
          </select>
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
            <button class="btn" onclick="saveProfile()">ğŸ’¾ Save</button>
            <button class="btn" onclick="deleteProfile()">ğŸ—‘ Delete</button>
          </div>
        </div>

        <div class="card glass-panel">
          <h3>ğŸ”§ Image Settings</h3>
          <div class="input-group">
            <span class="input-label">Resolution</span>
            <select class="form-control" id="camera-resolution" name="camera-resolution"
              onchange="cfg('resolution', this.value)">
              <option value="FRAMESIZE_UXGA">UXGA (1600x1200)</option>
              <option value="FRAMESIZE_SXGA">SXGA (1280x1024)</option>
              <option value="FRAMESIZE_HD">HD (1280x720)</option>
              <option value="FRAMESIZE_VGA" selected>VGA (640x480)</option>
              <option value="FRAMESIZE_QVGA">QVGA (320x240)</option>
              <option value="FRAMESIZE_QQVGA">QQVGA (160x120)</option>
            </select>
          </div>

          <div class="input-group">
            <div class="flex-row" style="margin-bottom:4px;display:flex;justify-content:space-between">
              <span class="input-label">Quality</span>
              <span class="value" id="lbl-qual">12</span>
            </div>
            <input type="range" min="4" max="63" value="12" id="camera-quality" name="camera-quality"
              oninput="el('lbl-qual').innerText=this.value" onchange="cfg('quality', this.value)">
          </div>

          <div class="input-group">
            <span class="input-label">Brightness</span>
            <input type="range" min="-2" max="2" value="0" id="camera-brightness" name="camera-brightness"
              onchange="cfg('brightness', this.value)">
          </div>
          <div class="input-group">
            <span class="input-label">Contrast</span>
            <input type="range" min="-2" max="2" value="0" id="camera-contrast" name="camera-contrast"
              onchange="cfg('contrast', this.value)">
          </div>
        </div>

        <div class="card glass-panel">
          <h3>ğŸ¨ Advanced Controls</h3>
          <div class="input-group">
            <div class="flex-row" style="margin-bottom:4px;display:flex;justify-content:space-between">
              <span class="input-label">Saturation</span>
              <span class="value" id="lbl-saturation">0</span>
            </div>
            <input type="range" min="-2" max="2" value="0" id="inp-saturation"
              oninput="el('lbl-saturation').innerText=this.value" onchange="cfg('saturation', this.value)">
          </div>

          <div class="input-group">
            <div class="flex-row" style="margin-bottom:4px;display:flex;justify-content:space-between">
              <span class="input-label">Exposure Level</span>
              <span class="value" id="lbl-aelevel">0</span>
            </div>
            <input type="range" min="-2" max="2" value="0" id="camera-ae-level" name="camera-ae-level"
              oninput="el('lbl-aelevel').innerText=this.value" onchange="cfg('ae_level', this.value)">
          </div>

          <div class="input-group">
            <div class="flex-row" style="margin-bottom:4px;display:flex;justify-content:space-between">
              <span class="input-label">Gain Ceiling</span>
              <span class="value" id="lbl-gain-ceil">0</span>
            </div>
            <input type="range" min="0" max="6" value="0" id="camera-gain-ceiling" name="camera-gain-ceiling"
              oninput="el('lbl-gain-ceil').innerText=this.value" onchange="cfg('gainceiling', this.value)">
          </div>

          <div class="kv-group">
            <span>Auto White Balance</span>
            <input type="checkbox" id="camera-awb" name="camera-awb" checked
              onchange="cfg('awb', this.checked ? 1 : 0)">
          </div>
          <div class="kv-group">
            <span>Auto Gain</span>
            <input type="checkbox" id="camera-agc" name="camera-agc" checked
              onchange="cfg('agc', this.checked ? 1 : 0)">
          </div>
        </div>

        <div class="card glass-panel">
          <h3>âš™ï¸ Advanced</h3>
          <div class="kv-group">
            <span>Auto Flash</span>
            <input type="checkbox" id="chk-autoflash" name="chk-autoflash"
              onchange="api('/api/autoflash', {method:'POST', body:JSON.stringify({enabled:this.checked})})">
          </div>
          <div class="kv-group">
            <span>Vertical Flip</span>
            <input type="checkbox" id="camera-vflip" name="camera-vflip" onchange="cfg('vflip', this.checked ? 1 : 0)">
          </div>
          <div class="kv-group">
            <span>H-Mirror</span>
            <input type="checkbox" id="camera-hmirror" name="camera-hmirror"
              onchange="cfg('hmirror', this.checked ? 1 : 0)">
          </div>
          <div class="kv-group">
            <span>Auto Exposure</span>
            <input type="checkbox" id="camera-aec" name="camera-aec" checked
              onchange="cfg('aec', this.checked ? 1 : 0)">
          </div>
        </div>

        <div class="card glass-panel" style="border-left: 4px solid var(--primary)">
          <h3>ğŸ“¡ ONVIF</h3>
          <div class="kv-group">
            <span>Enable ONVIF</span>
            <input type="checkbox" id="chk-onvif" name="chk-onvif" checked
              onchange="api('/api/onvif/toggle', {method:'POST', body:JSON.stringify({enabled:this.checked})})">
          </div>
        </div>
      </div>
    </div>

    <!-- PANEL: NETWORK (MERGED WITH CONNECTIVITY) -->
    <div id="tab-net" class="panel">
      <div class="grid">
        <!-- WiFi Section -->
        <div class="card glass-panel">
          <h3>ğŸ“¡ WiFi Manager</h3>
          <div style="background: rgba(0,0,0,0.2); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
            <div class="kv-group"><span class="label">SSID</span> <span class="value" id="wifi-ssid">...</span></div>
            <div class="kv-group"><span class="label">IP</span> <span class="value" id="wifi-ip">...</span></div>
          </div>
          <button class="btn btn-primary" style="width:100%; margin-bottom: 0.5rem" onclick="scanWifi()"
            id="btn-scan">Scan Networks</button>
          <div id="wifi-list"></div>
        </div>

        <!-- Network Diagnostics -->
        <div class="card glass-panel">
          <h3>ğŸ” Diagnostics</h3>
          <button class="btn" style="width:100%; margin-bottom: 0.5rem" id="btn-ping" onclick="runPingTest()">Run Ping
            Test</button>
          <div id="ping-result"
            style="padding: 0.5rem; background: rgba(0,0,0,0.2); border-radius: 4px; font-size: 0.85rem;">
            Click button to test latency
          </div>
        </div>

        <!-- Bluetooth & Audio Section -->
        <div class="card glass-panel">
          <h3>ğŸ¤ Audio</h3>
          <div class="input-group">
            <span class="input-label">Source</span>
            <select class="form-control" id="audio-src" name="audio-src"
              onchange="cfgBt({audioSource: parseInt(this.value)})">
              <option value="0">Mute</option>
              <option value="1">Hardware I2S</option>
              <option value="2">Bluetooth HFP</option>
            </select>
          </div>
          <div class="input-group">
            <div class="flex-row" style="margin-bottom:4px;display:flex;justify-content:space-between">
              <span class="input-label">Gain</span>
              <span class="value" id="lbl-gain">50%</span>
            </div>
            <input type="range" min="0" max="100" value="50" id="inp-gain" name="inp-gain"
              oninput="el('lbl-gain').innerText=this.value+'%'" onchange="cfgBt({gain: parseInt(this.value)})">
          </div>
        </div>

        <!-- Bluetooth Device Connection -->
        <div class="card glass-panel">
          <h3>ğŸ§ Bluetooth Devices</h3>

          <!-- Connection Status -->
          <div style="background: rgba(0,0,0,0.3); padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
            <div class="kv-group">
              <span class="label">Status</span>
              <span class="value" id="bt-status">Disconnected</span>
            </div>
            <div class="kv-group">
              <span class="label">Connected Device</span>
              <span class="value" id="bt-connected-name">None</span>
            </div>
          </div>

          <!-- Scan & Pair -->
          <button class="btn btn-primary" style="width:100%; margin-bottom: 0.5rem" onclick="scanBtDevices()">
            ğŸ” Scan for Devices
          </button>

          <!-- Scanned Devices List -->
          <div id="bt-devices-list" style="max-height: 250px; overflow-y: auto;"></div>
        </div>

        <!-- Bluetooth Settings -->
        <div class="card glass-panel">
          <h3>âš™ï¸ Bluetooth Settings</h3>
          <div class="kv-group">
            <span>Enable BT</span>
            <input type="checkbox" id="bt-enable" name="bt-enable" onchange="cfgBt({enabled:this.checked})">
          </div>
          <div class="kv-group">
            <span>Discoverable</span>
            <input type="checkbox" id="bt-discoverable" name="bt-discoverable"
              onchange="cfgBt({discoverable:this.checked})">
          </div>
          <div class="kv-group">
            <span>Stealth Mode</span>
            <input type="checkbox" id="bt-stealth" name="bt-stealth" onchange="cfgBt({stealth:this.checked})">
          </div>
          <div class="input-group">
            <div class="flex-row" style="margin-bottom:4px;display:flex;justify-content:space-between">
              <span class="input-label">Connection Timeout</span>
              <span class="value" id="lbl-timeout">120s</span>
            </div>
            <input type="range" min="30" max="600" step="30" value="120" id="inp-timeout" name="inp-timeout"
              oninput="el('lbl-timeout').innerText=this.value+'s'" onchange="cfgBt({timeout: parseInt(this.value)})">
          </div>
        </div>

        <!-- Presence Detection (Optional) -->
        <div class="card glass-panel">
          <h3>ğŸ“ Presence Detection</h3>
          <p style="font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem;">
            Monitor if a specific device is nearby (for automation)
          </p>
          <div class="input-group">
            <span class="input-label">Monitor MAC Address</span>
            <input type="text" class="form-control" id="bt-mac" name="bt-mac" placeholder="XX:XX:XX:XX:XX:XX"
              onchange="cfgBt({mac:this.value})">
          </div>
        </div>
      </div>
    </div>

    <!-- PANEL: EVENTS -->
    <div id="tab-events" class="panel">
      <div class="card glass-panel" style="max-width: 800px; margin: 0 auto;">
        <h3>ğŸ“ Event Log</h3>
        <button class="btn" style="margin-bottom: 1rem; width: 100%" onclick="clearEventLog()">ğŸ—‘ Clear Events</button>
        <div id="event-list" class="event-list"></div>
      </div>
    </div>

    <!-- PANEL: RECORDINGS -->
    <div id="tab-recordings" class="panel">
      <div class="card glass-panel" style="max-width: 900px; margin: 0 auto;">
        <h3>ğŸ¬ Video Recordings</h3>
        <button class="btn" style="margin-bottom: 1rem; width: 100%" onclick="loadRecordings()">ğŸ”„ Refresh List</button>
        <div id="recordings-list"></div>
      </div>
    </div>

    <!-- Video Player Modal -->
    <div id="video-modal" class="video-modal" onclick="if(event.target === this) closeVideoPlayer()">
      <div class="video-modal-content">
        <button class="video-modal-close" onclick="closeVideoPlayer()">âœ–</button>
        <video id="video-player" controls style="width: 100%; max-height: 70vh;"></video>
      </div>
    </div>

    <!-- PANEL: SYSTEM -->
    <div id="tab-sys" class="panel">
      <div class="grid">
        <div class="card glass-panel">
          <h3>ğŸ“¦ Firmware</h3>
          <input type="file" id="ota-file" class="form-control" accept=".bin" style="margin-bottom: 1rem">
          <div
            style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; overflow:hidden; margin-bottom: 1rem">
            <div id="ota-bar" style="width:0%; height:100%; background: var(--primary); transition: width 0.2s"></div>
          </div>
          <button class="btn btn-primary" onclick="startOTA()">Start Update</button>
        </div>

        <div class="card glass-panel">
          <h3>ğŸ’¾ SD Card</h3>
          <div class="kv-group"><span class="label">Total</span> <span class="value" id="sd-total">-</span></div>
          <div class="kv-group"><span class="label">Used</span> <span class="value" id="sd-used">-</span></div>
          <div class="kv-group"><span class="label">Free</span> <span class="value" id="sd-free">-</span></div>
          <div class="kv-group"><span class="label">Files</span> <span class="value" id="sd-files">-</span></div>
          <div
            style="height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow:hidden; margin-top: 0.5rem">
            <div id="sd-progress-bar" style="width:0%; height:100%; background: var(--success); transition: width 0.3s">
            </div>
          </div>
        </div>

        <div class="card glass-panel">
          <h3>âš™ï¸ Settings</h3>
          <button class="btn btn-primary" style="width:100%; margin-bottom: 0.5rem" onclick="exportSettings()">ğŸ’¾
            Export</button>
          <div style="display: flex; gap: 0.5rem; align-items: center;">
            <input type="file" id="import-file" class="form-control" accept=".json" style="flex: 1">
            <button class="btn" onclick="importSettings()">ğŸ“¥ Import</button>
          </div>
        </div>

        <div class="card glass-panel">
          <h3>ğŸ”§ Power</h3>
          <button class="btn" style="margin-bottom:0.5rem; width:100%" onclick="window.open('/api/sd/list','_blank')">ğŸ“‚
            Browse SD</button>
          <button class="btn" style="margin-bottom:0.5rem; width:100%"
            onclick="api('/api/time',{method:'POST',body:JSON.stringify({epoch:Math.floor(Date.now()/1000)})}).then(()=>alert('Synced!'))">ğŸ•’
            Sync Time</button>
          <button class="btn" style="margin-bottom:0.5rem; width:100%" onclick="updateSDInfo()">ğŸ”„ Refresh SD</button>
          <button class="btn" style="color:var(--danger); border-color:rgba(239,68,68,0.3); width:100%"
            onclick="if(confirm('Reboot?')) api('/reboot',{method:'POST'}).then(()=>alert('Rebooting...'))">ğŸ”„
            Reboot</button>
        </div>
      </div>
    </div>

  </main>

  <script src="app.js"></script>
</body>

</html>